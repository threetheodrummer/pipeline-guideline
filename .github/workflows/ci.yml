name: Pipeline Guardian - CI

on:
  push:
    branches: [ "main" ]
  pull_request:

jobs:
  # -------------------------------------------------
  # Phase 1: Secrets + SAST
  # -------------------------------------------------
  sast:
    name: secrets-and-sast
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Gitleaks secret scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Semgrep SAST
        uses: returntocorp/semgrep-action@v1
        with:
          config: p/ci

  # -------------------------------------------------
  # Phase 2: Dependency scanning (FIXED)
  # -------------------------------------------------
  dependencies:
    name: dependency-scan
    runs-on: ubuntu-latest
    needs: sast

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # âœ… CORRECT TRIVY DEPENDENCY SCAN (NO CLI)
      - name: Trivy dependency scan
        uses: aquasecurity/trivy-action@0.20.0
        with:
          scan-type: fs
          scan-ref: .
          format: json
          output: trivy-deps.json
          severity: HIGH,CRITICAL
          exit-code: 0
          ignore-unfixed: true

      - name: Upload dependency scan report
        uses: actions/upload-artifact@v4
        with:
          name: trivy-dependency-report
          path: trivy-deps.json

  # -------------------------------------------------
  # Phase 3: Container image scanning
  # -------------------------------------------------
  container:
    name: container-scan
    runs-on: ubuntu-latest
    needs: dependencies

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build Docker image
        run: |
          docker build -t pipeline-guardian:latest .

      - name: Trivy container scan
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: pipeline-guardian:latest
          severity: HIGH,CRITICAL
          exit-code: 0

  # -------------------------------------------------
  # Phase 4: DAST (kept but not blocking)
  # -------------------------------------------------
  dast:
    name: dast
    runs-on: ubuntu-latest
    needs: container

    steps:
      - name: Skip DAST for now
        run: echo "DAST will be enabled in later phase"
